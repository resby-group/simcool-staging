name: Deploy to Staging Droplet

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SIMCOOL_DEPLOY_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan -H 165.232.150.217 >> ~/.ssh/known_hosts

    - name: Deploy to droplet
      run: |
        ssh -o StrictHostKeyChecking=no root@165.232.150.217 "
          set -e

          echo '=============================='
          echo '   Starting Deployment'
          echo '=============================='

          cd /var/www/simcool

          echo '--- Pull latest code ---'
          git fetch origin main
          git reset --hard origin/main

          echo '--- Composer install ---'
          export COMPOSER_ALLOW_SUPERUSER=1
          composer install --no-dev --optimize-autoloader

          echo '--- Run Laravel migrations ---'
          php artisan migrate --force || true

          echo '--- Build Next.js frontend ---'
          cd frontend

          # Clean old build cache
          rm -rf .next || true
          rm -rf node_modules/.cache || true

          # Install dependencies safely
          npm install --legacy-peer-deps

          # Disable ESLint & Tailwind warnings breaking CI
          NEXT_DISABLE_ESLINT=1 \
          NEXT_TELEMETRY_DISABLED=1 \
          npm run build

          echo '--- Restarting PM2 ---'
          pm2 restart next-app || pm2 start npm --name next-app -- start

          echo '--- Restarting PHP-FPM ---'
          systemctl restart php8.4-fpm

          echo '=============================='
          echo '   Deployment Complete'
          echo '=============================='
        "
